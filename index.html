<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B-READY Methodology Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --wb-blue: #002244;
            --wb-blue-light: #003366;
            --wb-gold: #F4A100;
            --wb-gold-light: #FFB81C;
            --text-primary: #1a1a1a;
            --text-secondary: #555;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-color: #e0e0e0;
            --success: #28a745;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: linear-gradient(135deg, var(--wb-blue) 0%, var(--wb-blue-light) 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        header { text-align: center; padding: 24px 20px; color: white; }

        .logo-area { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 12px; }

        .logo-icon {
            width: 48px; height: 48px; background: var(--wb-gold); border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 20px; color: var(--wb-blue);
        }

        h1 { font-size: 1.75rem; font-weight: 600; letter-spacing: -0.5px; }

        .subtitle { font-size: 0.95rem; opacity: 0.85; margin-top: 4px; }

        .chat-container {
            flex: 1; background: var(--bg-white); border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex; flex-direction: column; overflow: hidden;
        }

        .chat-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 20px; background: var(--bg-light); border-bottom: 1px solid var(--border-color);
            font-weight: 600; color: var(--text-primary);
        }

        .new-chat-btn {
            background: var(--wb-blue); color: white; border: none; border-radius: 8px;
            padding: 8px 16px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
        }

        .messages { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; }

        .message { display: flex; gap: 12px; max-width: 85%; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message.user { align-self: flex-end; flex-direction: row-reverse; }

        .message-avatar {
            width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0;
        }

        .message.assistant .message-avatar { background: var(--wb-blue); color: white; }
        .message.user .message-avatar { background: var(--wb-gold); color: var(--wb-blue); }

        .message-content { padding: 14px 18px; border-radius: 16px; line-height: 1.6; font-size: 0.95rem; }

        .message.assistant .message-content { background: var(--bg-light); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .message.user .message-content { background: var(--wb-blue); color: white; border-bottom-right-radius: 4px; }

        /* Feedback Styling */
        #feedback-area {
            padding: 10px 24px;
            background: #fff;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            display: none; /* Hidden until bot replies */
        }

        .feedback-btn {
            background: none; border: 1px solid var(--border-color);
            padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: 0.2s;
        }

        .feedback-btn:hover { background: var(--bg-light); border-color: var(--wb-blue); }

        .input-area { padding: 20px 24px; border-top: 1px solid var(--border-color); background: var(--bg-white); }
        .input-wrapper { display: flex; gap: 12px; align-items: flex-end; }

        textarea {
            flex: 1; border: 2px solid var(--border-color); border-radius: 12px;
            padding: 14px 16px; resize: none; min-height: 52px; max-height: 150px;
        }

        #sendBtn {
            background: var(--wb-blue); color: white; border: none; border-radius: 12px;
            padding: 14px 24px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }

        .welcome-message { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .example-questions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; }
        .example-btn {
            background: var(--bg-light); border: 1px solid var(--border-color);
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem;
        }

        footer { text-align: center; padding: 16px; color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; }
    </style>
</head>
<body>

    <form name="chat-feedback" data-netlify="true" hidden>
        <input type="text" name="vote" />
        <input type="text" name="bot_response" />
    </form>

    <div class="container">
        <header>
            <div class="logo-area">
                <div class="logo-icon">B-R</div>
                <h1>B-READY Methodology Assistant</h1>
            </div>
            <p class="subtitle">Ask questions about the Business Ready methodology and indicators</p>
        </header>

        <div class="chat-container">
            <div class="chat-header">
                <span>Chat History</span>
                <button class="new-chat-btn" onclick="startNewChat()">+ New Chat</button>
            </div>
            
            <div class="messages" id="messages">
                <div class="welcome-message">
                    <h2>Welcome! How can I help you today?</h2>
                    <p>I'm trained on the B-READY Methodology Handbook. Ask me about topics, pillars, or scoring.</p>
                    <div class="example-questions">
                        <button class="example-btn" onclick="askQuestion('What are the three pillars in B-READY?')">What are the three pillars?</button>
                        <button class="example-btn" onclick="askQuestion('How is the Business Location topic scored?')">Business Location scoring</button>
                    </div>
                </div>
            </div>

            <div id="feedback-area">
                <span style="font-size: 0.85rem; color: var(--text-secondary);">Was this response helpful?</span>
                <button class="feedback-btn" onclick="sendFeedback('up')">üëç</button>
                <button class="feedback-btn" onclick="sendFeedback('down')">üëé</button>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <textarea id="userInput" placeholder="Ask a question about B-READY..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
                    <button id="sendBtn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <footer>
            Powered by Claude AI ‚Ä¢ <a href="https://www.worldbank.org/en/businessready" target="_blank" style="color: var(--wb-gold-light);">Official B-READY Site</a>
        </footer>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const feedbackArea = document.getElementById('feedback-area');
        
        let conversationHistory = [];
        let isLoading = false;

        function startNewChat() {
            conversationHistory = [];
            feedbackArea.style.display = 'none';
            messagesContainer.innerHTML = `<div class="welcome-message"><h2>New Chat Started</h2><p>Ask me anything about B-READY.</p></div>`;
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function askQuestion(question) {
            userInput.value = question;
            sendMessage();
        }

        function addMessage(content, role) {
            const welcome = messagesContainer.querySelector('.welcome-message');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'assistant' ? 'BR' : 'You';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = content.replace(/\n/g, '<br>');
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || isLoading) return;

            isLoading = true;
            sendBtn.disabled = true;
            feedbackArea.style.display = 'none'; // Hide feedback while thinking
            userInput.value = '';

            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });

            try {
                const response = await fetch('/.netlify/functions/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message, history: conversationHistory.slice(-6) })
                });

                const data = await response.json();
                
                if (data.error) {
                    addMessage('Error: Could not get response.', 'assistant');
                } else {
                    addMessage(data.response, 'assistant');
                    conversationHistory.push({ role: 'assistant', content: data.response });
                    // SHOW FEEDBACK BUTTONS AFTER RESPONSE
                    feedbackArea.style.display = 'flex';
                }
            } catch (error) {
                addMessage('Connection error.', 'assistant');
            }

            isLoading = false;
            sendBtn.disabled = false;
        }

        // FEEDBACK FUNCTION FOR NETLIFY
        function sendFeedback(voteValue) {
            const allMessages = document.querySelectorAll('.message-content');
            const lastBotMsg = allMessages.length > 0 ? allMessages[allMessages.length - 1].innerText : "N/A";

            fetch("/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                    "form-name": "chat-feedback",
                    "vote": voteValue,
                    "bot_response": lastBotMsg
                }).toString(),
            })
            .then(() => {
                feedbackArea.innerHTML = "<small>Thank you! Feedback saved to Netlify.</small>";
                setTimeout(() => {
                    feedbackArea.style.display = 'none';
                    // Reset feedback area for next time
                    feedbackArea.innerHTML = `<span style="font-size: 0.85rem; color: var(--text-secondary);">Was this response helpful?</span>
                                              <button class="feedback-btn" onclick="sendFeedback('up')">üëç</button>
                                              <button class="feedback-btn" onclick="sendFeedback('down')">üëé</button>`;
                }, 2000);
            })
            .catch((error) => console.error('Error:', error));
        }
    </script>
</body>
</html>
